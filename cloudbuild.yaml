# Cloud Build設定ファイル
# Streamlit アプリケーションをCloud Runにデプロイ

steps:
  # ステップ1: Dockerイメージのビルド
  - name: "gcr.io/cloud-builders/docker"
    id: "build-image"
    args:
      - "build"
      - "-f"
      - "Dockerfile.cloudrun"
      - "-t"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$SHORT_SHA"
      - "-t"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:latest"
      - "."
    timeout: 1200s

  # ステップ2: Artifact Registryへのプッシュ
  - name: "gcr.io/cloud-builders/docker"
    id: "push-image"
    args:
      - "push"
      - "--all-tags"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}"
    waitFor:
      - "build-image"

  # ステップ3: Cloud Runへのデプロイ
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-cloud-run"
    entrypoint: "gcloud"
    args:
      - "run"
      - "deploy"
      - "${_SERVICE_NAME}"
      - "--image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$SHORT_SHA"
      - "--region=${_REGION}"
      - "--platform=managed"
      - "--allow-unauthenticated"
      - "--port=8080"
      - "--cpu=2"
      - "--memory=2Gi"
      - "--timeout=300"
      - "--max-instances=10"
      - "--min-instances=0"
      - "--set-env-vars=CLOUD_RUN=true,PORT=8080,HEALTH_CHECK_PORT=8081,LOG_LEVEL=INFO"
      - "--set-secrets=GOOGLE_API_KEY=google-api-key:latest,DB_PASSWORD=database-password:latest"
      - "--add-cloudsql-instances=${_CLOUD_SQL_INSTANCE}"
      - "--set-env-vars=USE_CLOUD_SQL_PROXY=true,CLOUD_SQL_CONNECTION_NAME=${_CLOUD_SQL_INSTANCE},CLOUD_SQL_UNIX_SOCKET_DIR=/cloudsql,DB_USER=sagebase_user,DB_NAME=sagebase_db"
      - "--no-cpu-throttling"
    waitFor:
      - "push-image"

  # ステップ4: ヘルスチェックの確認
  - name: "gcr.io/cloud-builders/curl"
    id: "health-check"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')

        echo "Service URL: $SERVICE_URL"

        # ヘルスチェックエンドポイントの確認（最大30回リトライ）
        for i in {1..30}; do
          if curl -sf "$SERVICE_URL" > /dev/null; then
            echo "✓ Service is healthy"
            exit 0
          fi
          echo "Waiting for service to be ready... ($i/30)"
          sleep 10
        done

        echo "✗ Service health check failed"
        exit 1
    waitFor:
      - "deploy-cloud-run"

# 置換変数のデフォルト値
substitutions:
  _REGION: "asia-northeast1"
  _REPOSITORY: "polibase"
  _IMAGE_NAME: "polibase-streamlit"
  _SERVICE_NAME: "polibase-streamlit"
  _CLOUD_SQL_INSTANCE: "" # 'PROJECT_ID:REGION:INSTANCE_NAME' の形式で指定

# ビルドオプション
options:
  # ビルドマシンのスペック
  machineType: "E2_HIGHCPU_8"

  # ログ設定
  logging: CLOUD_LOGGING_ONLY

  # タイムアウト
  timeout: 1800s

  # ディスクサイズ
  diskSizeGb: 100

# 成果物の保存先
images:
  - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$SHORT_SHA"
  - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:latest"

# タグ
tags:
  - "cloud-run"
  - "streamlit"
  - "polibase"
