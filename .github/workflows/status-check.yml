name: CI/CD Status Check

on:
  workflow_run:
    workflows: ["Tests & Security Checks", "CI - Quick Checks"]
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  check-status:
    name: Check Workflow Status
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pullRequests = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (pullRequests.data.length > 0) {
              return pullRequests.data[0].number;
            }
            return null;

      - name: Comment on PR about failure
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.result }};
            const workflow_name = '${{ github.event.workflow_run.name }}';
            const run_url = '${{ github.event.workflow_run.html_url }}';
            const branch = '${{ github.event.workflow_run.head_branch }}';
            const commit = '${{ github.event.workflow_run.head_sha }}';

            const comment = `## âš ï¸ CI/CD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸ

            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${workflow_name}
            **ãƒ–ãƒ©ãƒ³ãƒ**: ${branch}
            **ã‚³ãƒŸãƒƒãƒˆ**: \`${commit.substring(0, 7)}\`

            [è©³ç´°ã‚’ç¢ºèªã™ã‚‹](${run_url})

            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å¤±æ•—ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
            2. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦å•é¡Œã‚’å†ç¾ã—ã¦ãã ã•ã„
            3. ä¿®æ­£å¾Œã€æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„

            ã”ä¸æ˜Žãªç‚¹ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: comment
            });

      - name: Create issue for main branch failure
        if: github.event.workflow_run.head_branch == 'main'
        uses: actions/github-script@v7
        with:
          script: |
            const workflow_name = '${{ github.event.workflow_run.name }}';
            const run_url = '${{ github.event.workflow_run.html_url }}';
            const commit = '${{ github.event.workflow_run.head_sha }}';
            const actor = '${{ github.event.workflow_run.actor.login }}';

            const title = `ðŸš¨ ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã®CI/CDãŒå¤±æ•—: ${workflow_name}`;
            const body = `## CI/CDå¤±æ•—ã®é€šçŸ¥

            ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã§CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚

            **è©³ç´°æƒ…å ±**:
            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${workflow_name}
            - **ã‚³ãƒŸãƒƒãƒˆ**: \`${commit}\`
            - **å®Ÿè¡Œè€…**: @${actor}
            - **å®Ÿè¡ŒURL**: ${run_url}

            **å„ªå…ˆåº¦**: é«˜

            æ—©æ€¥ãªå¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'ci-cd', 'high-priority'],
              assignees: [actor]
            });

  generate-summary:
    name: Generate Build Summary
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate workflow summary
        run: |
          echo "## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ…‹**: ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œè€…**: ${{ github.event.workflow_run.actor.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
