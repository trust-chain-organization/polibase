name: CI/CD Status Check

on:
  workflow_run:
    workflows: ["Tests & Security Checks", "CI - Quick Checks"]
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  check-status:
    name: Check Workflow Status
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pullRequests = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (pullRequests.data.length > 0) {
              return pullRequests.data[0].number;
            }
            return null;

      - name: Comment on PR about failure
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.result }};
            const workflow_name = '${{ github.event.workflow_run.name }}';
            const run_url = '${{ github.event.workflow_run.html_url }}';
            const branch = '${{ github.event.workflow_run.head_branch }}';
            const commit = '${{ github.event.workflow_run.head_sha }}';

            const comment = `## ⚠️ CI/CD ワークフローが失敗しました

            **ワークフロー**: ${workflow_name}
            **ブランチ**: ${branch}
            **コミット**: \`${commit.substring(0, 7)}\`

            [詳細を確認する](${run_url})

            ### 次のステップ
            1. 上記のリンクから失敗の詳細を確認してください
            2. ローカルでテストを実行して問題を再現してください
            3. 修正後、新しいコミットをプッシュしてください

            ご不明な点があれば、お気軽にお問い合わせください。`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: comment
            });

      - name: Create issue for main branch failure
        if: github.event.workflow_run.head_branch == 'main'
        uses: actions/github-script@v7
        with:
          script: |
            const workflow_name = '${{ github.event.workflow_run.name }}';
            const run_url = '${{ github.event.workflow_run.html_url }}';
            const commit = '${{ github.event.workflow_run.head_sha }}';
            const actor = '${{ github.event.workflow_run.actor.login }}';

            const title = `🚨 メインブランチのCI/CDが失敗: ${workflow_name}`;
            const body = `## CI/CD失敗の通知

            メインブランチでCI/CDワークフローが失敗しました。

            **詳細情報**:
            - **ワークフロー**: ${workflow_name}
            - **コミット**: \`${commit}\`
            - **実行者**: @${actor}
            - **実行URL**: ${run_url}

            **優先度**: 高

            早急な対応をお願いします。`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'ci-cd', 'high-priority'],
              assignees: [actor]
            });

  generate-summary:
    name: Generate Build Summary
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate workflow summary
        run: |
          echo "## ワークフロー実行サマリー" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ワークフロー**: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**状態**: ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_STEP_SUMMARY
          echo "**ブランチ**: ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**実行者**: ${{ github.event.workflow_run.actor.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "✅ ワークフローは正常に完了しました。" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ ワークフローが失敗しました。詳細を確認してください。" >> $GITHUB_STEP_SUMMARY
          fi
